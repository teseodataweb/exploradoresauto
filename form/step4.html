<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="/assets/style.css" />

  <title>Document</title>
</head>

<body>
  <div data-layer="Step 4" class="Step5">
    <div data-layer="wrapper" class="Wrapper">
      <div data-layer="header" class="Header">
        <div data-layer="logo" class="Logo">
          <div data-layer="datalpine" class="Datalpine">
            <img data-layer="logo_image" class="LogoImage" src="..\tools\logo.png" />
            <img data-layer="DatLogo" class="Datlogo" src="..\tools\DatLogo.png" />
          </div>
        </div>
        <a href="https://datalpine.mx/exploradores/" data-layer="Primary BTN" class="PrimaryBtn">
          <div data-layer="Button Text" class="ButtonText">Exploradores</div>
        </a>
      </div>
    </div>
    <div data-layer="form_step" class="FormStepFoto">
      <div data-layer="titulo" class="Titulo">Foto de la propiedad</div>
      <div data-layer="desc" class="DescText">
        Aseg√∫rese de ingresar todos los detalles, especialmente los
        obligatorios.
      </div>
      <div data-layer="step_form" class="StepForm StepForm33">
        <div data-layer="progreso" class="Progreso2 Progreso33">
          <div data-layer="steps" class="Steps">
            <div data-layer="step1_bar" class="Step1Bar">
              <div data-layer="Rectangle 4357" class="Rectangle4357 Rectangle4357Complete"></div>
            </div>

            <div data-layer="step2_bar" class="Step2BarComplete Step2BarComplete2"></div>

            <div data-layer="step3_bar" class="Step3Bar Step3BarComplete">
              <div data-layer="Rectangle 4357" class="Rectangle4358Complete"></div>
            </div>

            <div data-layer="step1_progreso" class="Step1Progreso Step1ProgresoComplete">
              <div data-layer="Ellipse 435" class="Ellipse435 Ellipse435Complete"></div>
              <div data-layer="1" class="numberOne numberOneComplete">
                <p>1</p>
              </div>
            </div>
            <div data-layer="step2_progreso" class="Step2Progreso">
              <div data-layer="Ellipse 436" class="Ellipse438 Ellipse438Complete"></div>
              <div data-layer="2" class="TwoC">
                <p>2</p>
              </div>
            </div>
            <div data-layer="step3_progreso" class="Step3Progreso Step3ProgresoYes">
              <div data-layer="Ellipse 437" class="Ellipse439 Ellipse439Complete"></div>
              <div data-layer="3" class="TreeC">
                <p>3</p>
              </div>
            </div>
            <div data-layer="step4_progreso" class="Step4Progreso">
              <div data-layer="Ellipse 437" class="Ellipse437 Ellipse437CompleteYes" k></div>
              <div data-layer="4" class="NumberFourNotCompleteYes">
                <p>4</p>
              </div>
            </div>
          </div>
        </div>
        <div data-layer="line" class="Line"></div>
        <div data-layer="step_foto" class="StepFoto">
          <div data-layer="titulo_foto" class="TituloFoto">
            <div data-layer="titulo" class="TituloFoto1">
              Fotograf√≠a de presentaci√≥n
            </div>
            <div data-layer="desc" class="Desc DescTT">
              Proporcionar la imagen representativa de su propiedad
            </div>
          </div>
          <div data-layer="drop_files" class="DropFoto" id="filesDrop">
            <div data-layer="drag_n_drop" class="DragNDrop">
              <div data-layer="file-upload" class="FileUpload">
                <input type="file" id="filesInput" multiple style="display: none" />
                <div data-layer="icon_image" class="IconImage">
                  <div data-layer="Vector 129" class="Vector129"></div>
                  <div data-layer="Vector 131" class="Vector131"></div>
                  <div data-layer="Rectangle 1" class="Rectangle1"></div>
                  <div data-layer="Rectangle 2" class="Rectangle2"></div>
                  <div data-layer="Ellipse 139" class="Ellipse139"></div>
                </div>
                <div data-layer="anuncio" class="Anuncio">
                  <div data-layer="text" class="Text">
                    <div data-layer="title" class="Title">
                      <div data-layer="text" class="Text">
                        Soltar los archivos aqu√≠ o
                      </div>

                      <div data-layer="links" class="Links">
                        <div data-layer="_link-default" class="LinkDefault">
                          <div data-layer="placeholder" class="Placeholder">
                            <input type="file" id="fotoInput" accept="image/*" style="display: none" />
                            <div class="LinkText" id="fotoLink">examinar</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div data-layer="tama√±o" class="Tamao">
                    Tama√±o m√°ximo: 5MB
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div data-layer="step_info" class="StepInfo">
          <div data-layer="titulo_info" class="TituloFoto">
            <div data-layer="titulo" class="TituloFoto1">
              Informaci√≥n de apoyo
            </div>
            <div data-layer="desc" class="DescInfo">
              Proporcionar archivos que provengan informaci√≥n relevante sobre
              su propiedad
            </div>
          </div>
          <div data-layer="drop_files" class="DropFoto" id="supportFilesDrop">
            <div data-layer="drag_n_drop" class="DragNDrop">
              <div data-layer="file-upload" class="FileUpload">
                <div data-layer="icon" class="IconFile">
                  <div data-layer="Vector" class="VectorFile"></div>
                  <div data-layer="icon_archive" class="IconArchive">
                    <div data-layer="Vector" class="VectorFile2"></div>
                    <div data-layer="Vector" class="VectorFile3"></div>
                  </div>
                  <div data-layer="Vector" class="VectorFile4"></div>
                  <div data-layer="Vector" class="VectorFile5"></div>
                </div>
                <div data-layer="anuncio" class="Anuncio">
                  <div data-layer="text" class="Text">
                    <div data-layer="title" class="Title">
                      Soltar los archivos aqu√≠ o
                    </div>
                    <div data-layer="links" class="Links">
                      <div data-layer="_link-default" class="LinkDefault">
                        <div data-layer="placeholder" class="Placeholder">
                          <input type="file" id="filesInput" multiple style="display: none" />
                          <div class="LinkText" id="filesLink">examinar</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div data-layer="navigation" class="Navigation">
        <a href="/form/step3_casa.html" data-layer="Secondary BTN" class="SecondaryBtn">
          <div data-layer="Button Text" class="ButtonTextWhite">Anterior</div>
        </a>
        <a href="/form/step5.html" id="nextBtn" data-layer="Primary BTN" class="PrimaryBtn">
          <div data-layer="Button Text" class="ButtonText">Siguiente</div>
        </a>
      </div>
    </div>
  </div>






<style>
  .input-error {
    border: 2px solid red !important;
  }
</style>

<script>
 (function () {
  const STORAGE_FOTOS = 'fotos';
  const STORAGE_APOYOS = 'apoyos';
  const userName = sessionStorage.getItem('nombre');

  const fotosQueue = JSON.parse(sessionStorage.getItem(STORAGE_FOTOS) || '[]');
  const apoyosQueue = JSON.parse(sessionStorage.getItem(STORAGE_APOYOS) || '[]');

  function saveQueues() {
    sessionStorage.setItem(STORAGE_FOTOS, JSON.stringify(fotosQueue));
    sessionStorage.setItem(STORAGE_APOYOS, JSON.stringify(apoyosQueue));
  }

  function crearVista(nombre, contenedorId) {
    const div = document.createElement('div');
    div.classList.add('file-item');

    const icon = document.createElement('span');
    icon.classList.add('file-icon');
    icon.textContent = nombre.match(/\.(jpe?g|png|gif)$/i) ? 'üñºÔ∏è' : 'üìÑ';

    const nameSpan = document.createElement('span');
    nameSpan.classList.add('file-name');
    nameSpan.textContent = nombre;

    const btn = document.createElement('button');
    btn.classList.add('file-remove');
    btn.setAttribute('aria-label', `Eliminar ${nombre}`);
    btn.innerHTML = '&times;';
    btn.addEventListener('click', () => {
      div.remove();
      if (contenedorId === 'filesDrop') {
        removeFromQueue(nombre, fotosQueue);
      } else {
        removeFromQueue(nombre, apoyosQueue);
      }
      saveQueues();
      updateValidationStyles(false);
    });

    div.append(icon, nameSpan);
    if (icon.textContent === 'üñºÔ∏è') {
      const img = document.createElement('img');
      img.src = '';
      img.style.maxWidth = '60px';
      img.style.marginLeft = '0.5rem';
      div.insertBefore(img, nameSpan);
    }
    div.appendChild(btn);

    document.getElementById(contenedorId).appendChild(div);
  }

  function removeFromQueue(nombre, queueArr) {
    const idx = queueArr.indexOf(nombre);
    if (idx > -1) queueArr.splice(idx, 1);
  }

  async function uploadFile(file, tipo) {
    const form = new FormData();
    form.append('nombre', userName);
    form.append('tipo', tipo);
    form.append('archivo', file);
    try {
      await fetch('../propiedades/guardar.php?upload=1', {
        method: 'POST',
        body: form
      });
    } catch (e) {
      console.error('Fetch error', e);
    }
  }

  function updateValidationStyles(showError) {
    const filesDrop = document.getElementById('filesDrop');
    if (showError && fotosQueue.length === 0) {
      filesDrop.classList.add('input-error');
    } else if (fotosQueue.length > 0) {
      filesDrop.classList.remove('input-error');
    }
  }

  async function handleFiles(files, tipo, contenedorId, queueArr) {
    for (const file of files) {
      if (!queueArr.includes(file.name)) {
        queueArr.push(file.name);
        crearVista(file.name, contenedorId);
        saveQueues();
        uploadFile(file, tipo);
      }
    }
    updateValidationStyles(false);
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (fotosQueue.length) fotosQueue.forEach(name => crearVista(name, 'filesDrop'));
    if (apoyosQueue.length) apoyosQueue.forEach(name => crearVista(name, 'supportFilesDrop'));
  });

  document.getElementById('fotoLink').onclick = () =>
    document.getElementById('fotoInput').click();
  document.getElementById('filesLink').onclick = () =>
    document.getElementById('filesInput').click();

  document.getElementById('fotoInput').addEventListener('change', e =>
    handleFiles(e.target.files, 'fotos', 'filesDrop', fotosQueue)
  );
  document.getElementById('filesInput').addEventListener('change', e =>
    handleFiles(e.target.files, 'apoyos', 'supportFilesDrop', apoyosQueue)
  );

  function makeDrop(areaId, tipo, queueArr, storageKey) {
    const area = document.getElementById(areaId);
    area.addEventListener('dragover', e => {
      e.preventDefault();
      area.style.border = '1px dashed #8DFF00';
    });
    area.addEventListener('dragleave', () => {
      area.style.border = '1px solid #ccc';
    });
    area.addEventListener('drop', e => {
      e.preventDefault();
      area.style.border = '1px solid #ccc';
      handleFiles(e.dataTransfer.files, tipo, areaId, queueArr);
    });
  }
  makeDrop('filesDrop', 'fotos', fotosQueue);
  makeDrop('supportFilesDrop', 'apoyos', apoyosQueue);

  document.getElementById('nextBtn').addEventListener('click', function (e) {
    if (fotosQueue.length === 0) {
      e.preventDefault();
      updateValidationStyles(true);
    }
  });

  document.getElementById('btnEnviar').addEventListener('click', async e => {
    e.preventDefault();
    const orden = [
      'nombre', 'dedication', 'prefijo', 'numerotel√©fono', 'email',
      'razon', 'DescribeRazon', 'tipo_propiedad', 'tipovienda', 'direccion',
      'idea', 'Condici√≥n', 'AnoConstruccion', 'mTerreno', 'mConstruccion',
      'Recamaras', 'Estacionamiento', 'Banos', 'midiobano', 'amenidades',
      'Precio', 'Moneda'
    ];
    const datos = {};
    for (const key of orden) {
      const v = sessionStorage.getItem(key);
      if (v !== null) datos[key] = v;
    }
    datos.fotos = fotosQueue;
    datos.apoyos = apoyosQueue;

    try {
      const resp = await fetch('../propiedades/guardar.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      const j = await resp.json();
      if (j.ok) {
        alert(`Guardado en propiedades/${j.archivo}`);
        sessionStorage.clear();
      } else {
        throw new Error(j.error);
      }
    } catch (err) {
      console.error(err);
    }
  });

  document.getElementById('back').addEventListener('click', () => {
    window.location.href = 'step3_casa.html';
  });
  document.getElementById('next').addEventListener('click', () => {
    window.location.href = 'step5.html';
  });
})();

</script>



  <script src="/form/script.js"></script>
</body>

</html>