<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fuentes de Google -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet" />

  <!-- Hoja de estilos personalizada -->
  <link rel="stylesheet" href="/assets/style.css" />

  <!-- OpenLayers CSS -->
  <link rel="stylesheet" href="https://openlayers.org/en/v6.5.0/css/ol.css" type="text/css">

  <title>Document</title>

  <!-- Scripts necesarios -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- OpenLayers JS -->
  <script src="https://openlayers.org/en/v6.5.0/build/ol.js"></script>
</head>

<body>
  <div data-layer="Step 2" class="Step1Map">
    <div data-layer="wrapper" class="Wrapper">
      <div data-layer="header" class="Header">
        <div data-layer="logo" class="Logo">
          <div data-layer="datalpine" class="Datalpine">
            <img data-layer="logo_image" class="LogoImage" src="..\tools\logo.png" />
            <img data-layer="DatLogo" class="Datlogo" src="..\tools\DatLogo.png" />
          </div>
        </div>
        <a href="https://datalpine.mx/exploradores/" data-layer="Primary BTN" class="PrimaryBtn">
          <div data-layer="Button Text" class="ButtonText">Exploradores</div>
        </a>
      </div>
    </div>

    <div class="espacioabajo"></div>
    <div data-layer="titulo" class="Titulo">Ubicación de la propiedad</div>
    <div data-layer="desc" class="Desc1">
      Asegúrese de ingresar todos los detalles, especialmente los obligatorios.
    </div>
    <p></p>
    <div data-layer="step_form" class="StepFormMap ">
      <div data-layer="progreso" class="Progreso Abajo">
        <div data-layer="steps" class="Steps">
          <div data-layer="step1_bar" class="Step1BarComplete">
            <div data-layer="Rectangle 4357" class="RectangleGreen22"></div>
          </div>
          <div data-layer="step2_bar" class="Step2Bar"></div>
          <div data-layer="step2_bar" class="RectangleGreen2"></div>
          <div data-layer="step3_bar" class="Step3Bar"></div>
          <div data-layer="step1_progreso" class="Step1Progreso">
            <div data-layer="Ellipse 435" class="Ellipse435"></div>
            <div data-layer="1" class="numberOne">
              <p>1</p>
            </div>
          </div>
          <div data-layer="step2_progreso" class="Step2Progreso ">
            <div data-layer="Ellipse 436" class="Ellipse4366 Elipse2Complete"></div>
            <div data-layer="2" class="numberTwoElipse2C">
              <p>2</p>
            </div>
          </div>
          <div data-layer="step3_progreso" class="Step3Progreso">
            <div data-layer="Ellipse 437" class="Ellipse437"></div>
            <div data-layer="3" class="NumberTree">
              <p>3</p>
            </div>
          </div>
          <div data-layer="step4_progreso" class="Step4Progreso">
            <div data-layer="Ellipse 437" class="Ellipse437 FourElipse"></div>
            <div data-layer="4" class="NumberFourNot">
              <p>4</p>
            </div>
          </div>
        </div>
        <br>
      </div>
      <div data-layer="line" class="Line"></div>
      <div data-layer="titulo_step" class="TituloStepMap">
        <div data-layer="titulo_step" class="Nombre">
          <div data-layer="titulo" class="NombreMap">Ubicación</div>
          <div data-layer="desc" class="TextMap">
            Ingresar la dirección exacta de la propiedad, utilice el mapa moviendo el pin para indicar la zona exacta
          </div>
        </div>
      </div>
      <form data-layer="form" class="FormDirec">
        <br>
        <div class="Step2Mapasa">
          <div class="Nombre">
            <label class="" for="cp">Código postal:</label><samp>*</samp><br>
            <input class="InputDirec" type="text" id="cp" name="cp" maxlength="5" placeholder="00000" required><br><br>
          </div>
          <div class="Nombre">
            <label class="" for="estado">Estado:</label><samp>*</samp><br>
            <input class="InputDirec" type="text" id="estado" name="estado" disabled required><br><br>
          </div>
        </div>
        <div class="Step2Mapasa">
          <div class="Nombre">
            <label class="Nombre" for="municipio">Municipio / Alcaldía:</label><samp>*</samp><br>
            <input class="InputDirec" type="text" id="municipio" name="municipio" disabled required><br><br>
          </div>
          <div class="Nombre">
            <label for="localidad">Localidad:</label><samp>*</samp><br>
            <select class="InputDirecSelect" id="localidad" name="localidad" required>
              <option value="">Seleccione una localidad</option>
            </select>
            <input class="InputDirec" type="text" id="localidad-custom" name="localidad-custom"
              placeholder="Escriba la localidad" style="display: none;" required><br><br>
          </div>
        </div>
        <div class="Step2Mapasa">
          <div class="Nombre">
            <label for="colonia">Colonia o barrio:</label><samp>*</samp><br>
            <select class="InputDirecSelect" type="text" id="colonia" name="colonia" required>
              <option value="">Seleccione una colonia</option>
            </select>
            <input class="InputDirec" type="text" id="colonia-custom" name="colonia-custom"
              placeholder="Escriba la colonia" style="display: none;" required><br><br>
          </div>
          <div class="Nombre">
            <label for="numero">Número:</label><samp>*</samp><br>
            <input class="InputDirec" type="text" id="numero" name="numero" placeholder="Ej. 123" required><br>
            <div id="error-message" style="color: red;"></div><br>
          </div>
        </div>
        <div class="Step2Mapasa">
          <div class="Nombre" style="width: 100%;">
            <label for="calle">Calle:</label><samp>*</samp><br>
            <input class="InputDirec" style="width: 93%;" type="text" id="calle" name="calle" placeholder="Ingrese nombre de la calle" required><br>
            <div id="error-message" style="color: red;"></div>
          </div>
        </div>
        <br>
        
        <a href="#" class="BtnBuscarMapa" id="buscarMapa">Buscar en el mapa</a>
        <div data-layer="desc" class="Desc">
          <i>Espera a que cargue el mapa para mover el pin</i>
        </div>
        <br>
      </form>
      <div data-layer="mapa" class="MapaImg">
        <div data-layer="iframe_mapa" class="IframeMapa" id="map" style="width: 100%; height: 400px;"></div>
      </div>
    </div>
    <div data-layer="navigation" class="Navigation2">
      <a href="./step1.html" data-layer="Secondary BTN" class="SecondaryBtn">
        <div data-layer="Button Text" class="ButtonTextWhite">Anterior</div>
      </a>
      <a href="./step3_casa.html" data-layer="Primary BTN" id="PrimaryBtn" class="PrimaryBtn">
        <div data-layer="Button Text" class="ButtonText">Siguiente</div>
      </a>
    </div>
  </div>

  <script>
    let cpData = [];

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      console.error(message);
    }

    function clearError() {
      document.getElementById('error-message').textContent = '';
    }

    async function loadExcelFile() {
      try {
        const response = await fetch('/assets/CPdescarga.xlsx');
        if (!response.ok) {
          throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
        }
        const data = await response.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });

        cpData = [];
        workbook.SheetNames.forEach(sheetName => {
          const sheet = workbook.Sheets[sheetName];
          const sheetData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          cpData = cpData.concat(sheetData);
        });

        cpData = cpData.map(row => ({
          ...row,
          d_codigo: row.d_codigo ? String(row.d_codigo).trim() : ''
        }));

        console.log('Archivo Excel cargado correctamente, total registros:', cpData.length);
        clearError();
      } catch (error) {
        showError(`Error al cargar el archivo Excel: ${error.message}`);
      }
    }

    function updateFields() {
      clearError();
      const cp = document.getElementById('cp').value.trim();
      if (!cp || cpData.length === 0) {
        showError('Datos no cargados o código postal inválido');
        return;
      }

      const matches = cpData.filter(row => row.d_codigo === cp);

      if (matches.length === 0) {
        alert('Código postal inválido');
        document.getElementById('estado').value = '';
        document.getElementById('municipio').value = '';
        document.getElementById('localidad').innerHTML = '<option value="">Seleccione una localidad</option>';
        document.getElementById('localidad-custom').style.display = 'none';
        document.getElementById('localidad-custom').value = '';
        document.getElementById('colonia').innerHTML = '<option value="">Seleccione una colonia</option>';
        document.getElementById('colonia-custom').style.display = 'none';
        document.getElementById('colonia-custom').value = '';
        return;
      }

      document.getElementById('estado').value = matches[0].d_estado || '';
      document.getElementById('municipio').value = matches[0].D_mnpio || '';

      const localidades = [...new Set(matches.map(row => row.d_ciudad).filter(ciudad => ciudad))];
      const localidadSelect = document.getElementById('localidad');
      localidadSelect.innerHTML = '<option value="">Seleccione una localidad</option>';
      localidades.forEach(localidad => {
        const option = document.createElement('option');
        option.value = localidad;
        option.text = localidad;
        localidadSelect.appendChild(option);
      });
      const otherOptionLocalidad = document.createElement('option');
      otherOptionLocalidad.value = 'other';
      otherOptionLocalidad.text = 'Otro';
      localidadSelect.appendChild(otherOptionLocalidad);

      const colonias = matches.map(row => row.d_asenta).filter(colonia => colonia);
      const coloniaSelect = document.getElementById('colonia');
      coloniaSelect.innerHTML = '<option value="">Seleccione una colonia</option>';
      colonias.forEach(colonia => {
        // Opción por defecto
        const option = document.createElement('option');
        option.value = colonia;
        option.text = colonia;
        coloniaSelect.appendChild(option);
      });
      const otherOptionColonia = document.createElement('option');
      otherOptionColonia.value = 'other';
      otherOptionColonia.text = 'Otro';
      coloniaSelect.appendChild(otherOptionColonia);
    }

    var map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.OSM()
        })
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([-99.1332, 19.4326]),
        zoom: 12
      })
    });

    var vectorSource = new ol.source.Vector();
    var markerLayer = new ol.layer.Vector({
      source: vectorSource,
      style: new ol.style.Style({
        image: new ol.style.Icon({
          anchor: [0.5, 1],
          src: 'https://openlayers.org/en/latest/examples/data/icon.png'
        })
      })
    });
    map.addLayer(markerLayer);

    function addOrMoveMarker(coordinates) {
      vectorSource.clear();
      var marker = new ol.Feature({
        geometry: new ol.geom.Point(coordinates)
      });
      vectorSource.addFeature(marker);
    }

    // Clic en el mapa: mover marcador (opcional)
    map.on('click', function (event) {
      var coordinates = event.coordinate;
      addOrMoveMarker(coordinates);
    });

    var translateInteraction = new ol.interaction.Translate({
      features: vectorSource.getFeaturesCollection()
    });
    map.addInteraction(translateInteraction);

    function buscarDireccion() {
      var cp = document.getElementById('cp').value;
      var estado = document.getElementById('estado').value;
      var municipio = document.getElementById('municipio').value;
      var localidad = document.getElementById('localidad').value === 'other'
        ? document.getElementById('localidad-custom').value
        : document.getElementById('localidad').value;
      var colonia = document.getElementById('colonia').value === 'other'
        ? document.getElementById('colonia-custom').value
        : document.getElementById('colonia').value;
      var numero = document.getElementById('numero').value;
      var calle = document.getElementById('calle').value;

      if (!cp || !estado || !municipio) {
        alert('Por favor, completa los campos obligatorios: Código postal, Estado y Municipio');
        return;
      }
      function normalizarTexto(texto) {
        return texto
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")  // Elimina acentos
          .replace(/[^\w\s]/gi, '')         // Elimina caracteres especiales
          .replace(/\s+/g, ' ')             // Sustituye múltiples espacios por uno
          .trim();
      }

      // var direccion = [ calle,numero, colonia, localidad, municipio, estado, cp, 'México']
      var direccion = [
       // normalizarTexto(calle), 
        numero,
        normalizarTexto(colonia),
        normalizarTexto(localidad),
        normalizarTexto(municipio),
        normalizarTexto(estado),
        cp,
        'México'
      ]
        .filter(Boolean)
        .join(', ');

      var query = encodeURIComponent(direccion);

      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
        .then(response => response.json())
        .then(data => {
          if (data.length > 0) {
            var lon = parseFloat(data[0].lon);
            var lat = parseFloat(data[0].lat);
            var coordinates = ol.proj.fromLonLat([lon, lat]);

            map.getView().setCenter(coordinates);
            map.getView().setZoom(16);
            addOrMoveMarker(coordinates);

            // Guardar coordenadas
            sessionStorage.setItem("mapCoords", JSON.stringify({ lon, lat }));
          } else {
            alert('No se encontró la dirección');
          }
        })
        .catch(error => {
          console.error('Error en la geocodificación:', error);
          alert('Error al buscar la dirección');
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadExcelFile().then(() => {
        const saved = sessionStorage.getItem("direccionData");
        if (saved) {
          const data = JSON.parse(saved);
          document.getElementById("cp").value = data.cp || "";
          if (data.cp) {
            document.getElementById("cp").dispatchEvent(new Event("input"));
            setTimeout(() => {
              document.getElementById("estado").value = data.estado || "";
              document.getElementById("municipio").value = data.municipio || "";
              const localidadSelect = document.getElementById("localidad");
              if (localidadSelect && data.localidad) {
                const optionExists = [...localidadSelect.options].some(opt => opt.value === data.localidad);
                if (optionExists) {
                  localidadSelect.value = data.localidad;
                } else {
                  localidadSelect.value = "other";
                  document.getElementById("localidad-custom").style.display = "block";
                  document.getElementById("localidad-custom").value = data.localidad;
                }
              }
              const coloniaSelect = document.getElementById("colonia");
              if (coloniaSelect && data.colonia) {
                const optionExists = [...coloniaSelect.options].some(opt => opt.value === data.colonia);
                if (optionExists) {
                  coloniaSelect.value = data.colonia;
                } else {
                  coloniaSelect.value = "other";
                  document.getElementById("colonia-custom").style.display = "block";
                  document.getElementById("colonia-custom").value = data.colonia;
                }
              }
              document.getElementById("numero").value = data.numero || "";
              document.getElementById("calle").value = data.calle || "";
            }, 500);
          }
        }

        // Restaurar marcador del mapa si hay coordenadas guardadas
        const savedCoords = sessionStorage.getItem("mapCoords");
        if (savedCoords) {
          const { lon, lat } = JSON.parse(savedCoords);
          const coordinates = ol.proj.fromLonLat([lon, lat]);
          map.getView().setCenter(coordinates);
          map.getView().setZoom(16);
          addOrMoveMarker(coordinates);
        }
      });

      document.getElementById('cp').addEventListener('input', () => {
        if (document.getElementById('cp').value.length === 5) {
          updateFields();
        } else {
          document.getElementById('estado').value = '';
          document.getElementById('municipio').value = '';
          document.getElementById('localidad').innerHTML = '<option value="">Seleccione una localidad</option>';
          document.getElementById('localidad-custom').style.display = 'none';
          document.getElementById('localidad-custom').value = '';
          document.getElementById('colonia').innerHTML = '<option value="">Seleccione una colonia</option>';
          document.getElementById('colonia-custom').style.display = 'none';
          document.getElementById('colonia-custom').value = '';
          clearError();
        }
      });

      document.getElementById('localidad').addEventListener('change', function () {
        const customInput = document.getElementById('localidad-custom');
        if (this.value === 'other') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
          customInput.value = '';
        }
      });

      document.getElementById('colonia').addEventListener('change', function () {
        const customInput = document.getElementById('colonia-custom');
        if (this.value === 'other') {
          customInput.style.display = 'block';
          customInput.focus();
        } else {
          customInput.style.display = 'none';
          customInput.value = '';
        }
      });

      document.getElementById("PrimaryBtn").addEventListener("click", () => {
        const direccionData = {
          cp: document.getElementById("cp").value,
          estado: document.getElementById("estado").value,
          municipio: document.getElementById("municipio").value,
          localidad: document.getElementById("localidad").value === "other"
            ? document.getElementById("localidad-custom").value
            : document.getElementById("localidad").value,
          colonia: document.getElementById("colonia").value === "other"
            ? document.getElementById("colonia-custom").value
            : document.getElementById("colonia").value,
          numero: document.getElementById("numero").value,
          numero: document.getElementById("calle").value
        };
        sessionStorage.setItem("direccionData", JSON.stringify(direccionData));
      });

      document.getElementById('buscarMapa').addEventListener('click', function (event) {
        event.preventDefault();
        buscarDireccion();
      });
    });
  </script>

</body>

</html>